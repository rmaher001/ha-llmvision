alias: Detect Tow Truck
description: Are we gonna get towed?
triggers:
  - trigger: state
    entity_id:
      - binary_sensor.entrance_camera_motion
    to: "on"
conditions:
  - condition: or
    conditions:
      - condition: state
        entity_id: binary_sensor.garage_camera_smart_occupancy_sensor_occupancysensor
        state: "on"
      - condition: state
        entity_id: input_boolean.test_tow_truck_mode
        state: "on"
actions:
  - action: ai_task.generate_data
    data:
      task_name: Detect tow truck or patrol car outside the garage
      instructions: >-
        You are looking at the street outside the garage. Do you see a tow
        truck or patrol car?
      structure:
        tow_truck:
          description: Tow truck
          required: true
          selector:
            boolean: null
        patrol_car:
          description: Patrol car
          required: true
          selector:
            boolean: null
      attachments: >-
        {% if is_state('input_boolean.test_tow_truck_mode', 'on') %}
          {
            "media_content_id": "media-source://media_source/test_images/{{ states('input_select.test_tow_truck_image_select') }}",
            "media_content_type": "image/jpeg",
            "metadata": {
              "title": "Test Image - {{ states('input_select.test_tow_truck_image_select') }}",
              "media_class": "image"
            }
          }
        {% else %}
          {
            "media_content_id": "media-source://camera/camera.entrance_camera_clear",
            "media_content_type": "application/vnd.apple.mpegurl",
            "metadata": {
              "title": "Garage Camera HD Stream",
              "thumbnail": "/api/camera_proxy/camera.entrance_camera_clear",
              "media_class": "video",
              "children_media_class": null,
              "navigateIds": [
                {},
                {
                  "media_content_type": "app",
                  "media_content_id": "media-source://camera"
                }
              ]
            }
          }
        {% endif %}
      entity_id: ai_task.google_ai_task
    response_variable: response
  - if:
      - condition: or
        conditions:
          - condition: template
            value_template: "{{ response.data.tow_truck }}"
          - condition: template
            value_template: "{{ response.data.patrol_car }}"
    then:
      - variables:
          vehicle_type: >-
            {% if response.data.tow_truck %}
              tow truck
            {% else %}
              patrol car
            {% endif %}
          vehicle_title: >-
            {% if response.data.tow_truck %}
              Tow Truck
            {% else %}
              Patrol Car
            {% endif %}
          alert_message: "Move the car now, {{ vehicle_title }} spotted outside, move the car immediately."
      - action: notify.persistent_notification
        data:
          message: "{{ alert_message }}"
          title: "{{ vehicle_title }} outside"
      - action: media_player.volume_set
        data:
          volume_level: 0.75
        target:
          entity_id:
            - media_player.bathroom_speaker
            - media_player.kitchen_display_2
            - media_player.master_bedroom_speaker
      - delay:
          seconds: 2
      - repeat:
          count: 3
          sequence:
            - action: tts.cloud_say
              data:
                cache: false
                message: "{{ alert_message }}"
              target:
                entity_id: media_player.home_group
            - delay:
                seconds: 5
      - action: notify.richard_ram6_com
        data:
          title: "ðŸ”´ Move the car NOW - {{ vehicle_title }} Spotted"
          message: "{{ alert_message }}"
          data:
            from: richard@ram6.com
          target:
            - 9497344665@msg.fi.google.com
            - richard@ram6.com
            - 9497340018@msg.fi.google.com
            - olesia@ram6.com
      - action: media_player.volume_set
        data:
          volume_level: 0.35
        target:
          entity_id:
            - media_player.bathroom_speaker
            - media_player.kitchen_display_2
            - media_player.master_bedroom_speaker
alias: Simple Package Detection
description: >-
  State-based package detection using structured output from multiple cameras.
  Detects package presence rather than activities.
triggers:
  - trigger: event
    event_type: dahua_event_received
    event_data:
      name: Front Full Camera
      Code: CrossLineDetection
      action: Start
      data:
        Name: Enter-Patio
        Direction: RightToLeft
        Object:
          Action: Appear
          ObjectType: Human
    id: person_approaching
  - trigger: event
    event_type: dahua_event_received
    event_data:
      name: Front Full Camera
      Code: CrossRegionDetection
      action: Start
      data:
        Direction: Leave
        Name: Door-Area
        Object:
          ObjectType: Human
    id: person_exiting_house
  - trigger: time_pattern
    hours: /1
    id: periodic_check
conditions:
  - condition: time
    after: "07:00:00"
    before: "22:00:00"
actions:
  - variables:
      check_time: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      trigger_type: "{{ trigger.id }}"
  - action: llmvision.stream_analyzer
    data:
      remember: true
      use_memory: false
      max_frames: 6
      include_filename: true
      target_width: 1280
      max_tokens: 1000
      generate_title: false
      expose_images: false
      response_format: json
      provider: 01K4JMYCVPRJYJZ1Z37E79GQ57
      message: |2-
          Analyze these camera views for packages/deliveries and delivery personnel.
          Look for: 1) Boxes, envelopes, or delivery bags near the door or on the porch
          2) Delivery person in uniform (Amazon, UPS, FedEx, USPS, DHL) Identify carrier
          by uniform colors/logos if visible. Ignore residents, pets, plants, furniture,
          and decorations.
      image_entity:
        - camera.doorbell_clear
        - camera.front_side_camera_hd_stream_direct
        - camera.full_front_camera_main
      duration: 6
      min_frames_per_camera: 2
      structure: |2-
                {
                  "type": "object",
                  "properties": {
                    "package_present": {
                      "type": "boolean",
                      "description": "Is there a package/delivery visible?"
                    },
                    "confidence": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1,
                      "description": "Confidence score"
                    },
                    "location": {
                      "type": "string",
                      "enum": ["door", "porch", "walkway", "none"],
                      "description": "Where is the package located?"
                    },
                    "package_count": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "Number of packages visible"
                    },
                    "delivery_person": {
                      "type": "boolean",
                      "description": "Is a delivery person visible?"
                    },
                    "carrier": {
                      "type": "string",
                      "enum": ["Amazon", "UPS", "FedEx", "USPS", "DHL", "Unknown", "None"],
                      "description": "Delivery carrier if identifiable"
                    },
                    "description": {
                      "type": "string",
                      "description": "Brief description of what is visible"
                    }
                  },
                  "required": ["package_present", "confidence", "location", "package_count", "delivery_person", "carrier", "description"],
                  "additionalProperties": false
                }
    response_variable: detection_result
  - variables:
      package_detected: >-
        {{ detection_result.structured_response.package_present | default(false)
        }}
      confidence: "{{ detection_result.structured_response.confidence | default(0) }}"
      location: "{{ detection_result.structured_response.location | default('none') }}"
      package_count: "{{ detection_result.structured_response.package_count | default(0) }}"
      delivery_person: >-
        {{ detection_result.structured_response.delivery_person | default(false)
        }}
      carrier: "{{ detection_result.structured_response.carrier | default('None') }}"
      description: >-
        {{ detection_result.structured_response.description | default('No
        packages detected') }}
      current_state: "{{ states('input_boolean.package_at_door') }}"
  - action: persistent_notification.create
    data:
      title: Package Detection Check
      message: >
        **Time:** {{ check_time }}

        **Trigger:** {{ trigger_type }}

        **Package Detected:** {{ 'Yes' if package_detected else 'No' }}

        **Confidence:** {{ (confidence * 100) | round(0) }}%

        **Location:** {{ location }}

        **Count:** {{ package_count }}

        **Delivery Person:** {{ 'Yes' if delivery_person else 'No' }}

        **Carrier:** {{ carrier }}

        **Description:** {{ description }}

        **Current State:** {{ current_state }}

        **State Change:** {{ 'Yes' if (package_detected and current_state ==
        'off') or (not package_detected and current_state == 'on') else 'No' }}
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ package_detected and confidence >= 0.7 }}"
          - condition: state
            entity_id: input_boolean.package_at_door
            state: "off"
        sequence:
          - action: input_boolean.turn_on
            target:
              entity_id: input_boolean.package_at_door
          - action: notify.persistent_notification
            data:
              title: >-
                ðŸ“¦ Package Delivered{% if carrier != 'None' and carrier !=
                'Unknown' %} - {{ carrier }}{% endif %}
              message: |
                {{ package_count }} package(s) detected at {{ location }}
                {% if carrier != 'None' %}Carrier: {{ carrier }}{% endif %}
                {% if delivery_person %}Delivery person seen{% endif %}
                {{ description }}
                Time: {{ check_time }}
          - action: notify.mobile_app_pixel_10_pro_fold
            data:
              title: >-
                ðŸ“¦ {% if carrier != 'None' and carrier != 'Unknown' %}{{ carrier
                }} {% endif %}Package Delivered
              message: >-
                {{ package_count }} package(s) at {{ location }}{% if
                delivery_person %} - delivery person seen{% endif %}
              data:
                tag: package_delivery
                importance: high
          - action: media_player.volume_set
            data:
              volume_level: 0.35
            target:
              entity_id: media_player.home_group
          - action: tts.cloud_say
            data:
              cache: false
              message: |
                {% if carrier != 'None' and carrier != 'Unknown' %}
                  {{ carrier }} package delivered at {{ location }}. {{ package_count }} package{{ 's' if package_count > 1 else '' }} detected.
                {% else %}
                  Package delivered at {{ location }}. {{ package_count }} package{{ 's' if package_count > 1 else '' }} detected.
                {% endif %}
            target:
              entity_id: media_player.home_group
      - conditions:
          - condition: template
            value_template: "{{ not package_detected and confidence >= 0.7 }}"
          - condition: state
            entity_id: input_boolean.package_at_door
            state: "on"
        sequence:
          - action: input_boolean.turn_off
            target:
              entity_id: input_boolean.package_at_door
          - action: notify.persistent_notification
            data:
              title: ðŸ“¦ Package Collected
              message: |
                Package has been picked up
                Time: {{ check_time }}
          - action: notify.mobile_app_pixel_10_pro_fold
            data:
              title: ðŸ“¦ Package Collected
              message: Package has been picked up from {{ location }}
              data:
                tag: package_pickup
                importance: default
          - action: media_player.volume_set
            data:
              volume_level: 0.35
            target:
              entity_id: media_player.home_group
          - action: tts.cloud_say
            data:
              cache: false
              message: Package has been picked up from {{ location }}.
            target:
              entity_id: media_player.home_group
mode: single
max_exceeded: silent
trace:
  stored_traces: 100
